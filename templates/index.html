<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Pitch Shifter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px 20px;
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            text-align: center;
            font-size: 28px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 35px;
            font-size: 18px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: #2c3e50;
            font-size: 20px;
            margin-bottom: 18px;
            font-weight: 600;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            color: #34495e;
            margin-bottom: 12px;
            font-weight: 500;
            font-size: 18px;
        }
        
        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e0e0e0;
            outline: none;
            margin-bottom: 15px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
        }
        
        .value-display {
            text-align: center;
            color: #3498db;
            font-weight: 600;
            font-size: 22px;
            margin-top: 10px;
        }
        
        /* åœ†å½¢å½•éŸ³æŒ‰é’® */
        .record-button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .btn-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            line-height: 1.2;
        }
        
        .btn-circle .icon {
            font-size: 36px;
            display: block;
            line-height: 1;
            margin-bottom: 6px;
        }
        
        .btn-circle span:last-child {
            display: block;
            line-height: 1.2;
        }
        
        .btn-circle:active {
            opacity: 0.8;
        }
        
        #recordBtn {
            background: #3498db;
            color: white;
        }
        
        #stopBtn {
            background: #e74c3c;
            color: white;
        }
        
        /* æ™®é€šæŒ‰é’® */
        .btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 12px;
            font-size: 22px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .btn-secondary {
            background: #27ae60;
            color: white;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .btn-secondary:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            text-align: center;
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            display: none;
            font-size: 19px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        
        .status.processing {
            background: #d1ecf1;
            color: #0c5460;
            display: block;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        audio {
            width: 100%;
            margin-top: 15px;
            border-radius: 8px;
            height: 54px;
        }
        
        /* å•é€‰æŒ‰é’®æ ·å¼ä¼˜åŒ– */
        input[type="radio"] {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .control-group label[style] {
            font-size: 20px;
            padding: 12px;
            margin-bottom: 8px;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 25px 15px;
            }
            
            h1 {
                font-size: 26px;
            }
            
            .subtitle {
                font-size: 17px;
            }
            
            .section-title {
                font-size: 19px;
            }
            
            label {
                font-size: 17px;
            }
            
            .value-display {
                font-size: 20px;
            }
            
            .btn {
                font-size: 20px;
                padding: 18px;
            }
            
            .btn-circle {
                width: 100px;
                height: 100px;
                font-size: 16px;
            }
            
            .btn-circle .icon {
                font-size: 32px;
            }
            
            .status {
                font-size: 17px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ è¯­éŸ³é™è°ƒåŠ©å¬å™¨</h1>
        <p class="subtitle">å¸®åŠ©è€å¹´äººæ›´æ¸…æ™°åœ°å¬åˆ°å¯¹è¯</p>
        
        <div class="section">
            <div class="section-title">é™è°ƒè°ƒæ•´ï¼ˆç›¸å¯¹é™ä½ï¼‰</div>
            <div class="control-group">
                <label for="semitones">é™ä½åŠéŸ³æ•°: <span id="semitone-value">-3.0</span></label>
                <input type="range" id="semitones" min="-12" max="0" step="0.5" value="-3">
                <div class="value-display" id="pitch-description">è½»åº¦é™ä½ï¼ˆé€‚åˆå¥³å£°ï¼‰</div>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title">ä»éº¦å…‹é£å½•éŸ³</div>
            <div class="record-button-container">
                <button id="recordBtn" class="btn-circle">
                    <span class="icon">ğŸ™ï¸</span>
                    <span>å¼€å§‹å½•éŸ³</span>
                </button>
                <button id="stopBtn" class="btn-circle" style="display: none;">
                    <span class="icon">â¹ï¸</span>
                    <span>åœæ­¢å½•éŸ³</span>
                </button>
            </div>
            <audio id="recordedAudio" controls style="display: none;"></audio>
        </div>
        
        <button id="processBtn" class="btn btn-secondary" disabled>âœ¨ é™ä½å£°è°ƒ</button>
        
        <div id="status" class="status"></div>
        
        <div id="speedControlSection" class="section" style="display: none;">
            <div class="section-title">é€Ÿåº¦è°ƒæ•´ï¼ˆæ’­æ”¾æ—¶å®æ—¶è°ƒæ•´ï¼‰</div>
            <div class="control-group">
                <label>é€‰æ‹©æ’­æ”¾é€Ÿåº¦:</label>
                <div style="margin-top: 10px;">
                    <label style="display: inline-block; margin-right: 20px; cursor: pointer;">
                        <input type="radio" name="speed" value="1.0" checked style="margin-right: 5px;">æ­£å¸¸é€Ÿåº¦ (1.0x)
                    </label>
                    <label style="display: inline-block; margin-right: 20px; cursor: pointer;">
                        <input type="radio" name="speed" value="0.8" style="margin-right: 5px;">è¾ƒæ…¢ (0.8x)
                    </label>
                    <label style="display: inline-block; cursor: pointer;">
                        <input type="radio" name="speed" value="0.6" style="margin-right: 5px;">å¾ˆæ…¢ (0.6x)
                    </label>
                </div>
            </div>
        </div>
        
        <audio id="outputAudio" controls style="display: none;"></audio>
    </div>
    
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let currentAudioBlob = null;
        
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const processBtn = document.getElementById('processBtn');
        const semitonesSlider = document.getElementById('semitones');
        const semitoneValue = document.getElementById('semitone-value');
        const pitchDescription = document.getElementById('pitch-description');
        const recordedAudio = document.getElementById('recordedAudio');
        const outputAudio = document.getElementById('outputAudio');
        const status = document.getElementById('status');
        
        // Update pitch description
        semitonesSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            semitoneValue.textContent = value.toFixed(1);
            
            if (value === 0) {
                pitchDescription.textContent = 'ä¸é™è°ƒï¼ˆåŸå£°ï¼‰';
            } else if (value > -3) {
                pitchDescription.textContent = 'è½»å¾®é™ä½ï¼ˆé€‚åˆç•¥é«˜çš„å£°éŸ³ï¼‰';
            } else if (value >= -6) {
                pitchDescription.textContent = 'è½»åº¦é™ä½ï¼ˆé€‚åˆå¥³å£°ï¼‰';
            } else if (value >= -9) {
                pitchDescription.textContent = 'ä¸­åº¦é™ä½ï¼ˆé€‚åˆé«˜éŸ³å¥³å£°ï¼‰';
            } else {
                pitchDescription.textContent = 'é‡åº¦é™ä½ï¼ˆé€‚åˆç‰¹åˆ«å°–çš„å£°éŸ³ï¼‰';
            }
        });
        
        // Update playback speed in real-time
        document.querySelectorAll('input[name="speed"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const speed = parseFloat(e.target.value);
                if (outputAudio.src) {
                    outputAudio.playbackRate = speed;
                }
                if (recordedAudio.src) {
                    recordedAudio.playbackRate = speed;
                }
            });
        });
        
        // Recording functionality
        recordBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Try to use WAV format if supported, otherwise use webm
                let options = { mimeType: 'audio/wav' };
                if (!MediaRecorder.isTypeSupported('audio/wav')) {
                    options = { mimeType: 'audio/webm' };
                }
                
                mediaRecorder = new MediaRecorder(stream, options);
                audioChunks = [];
                
                mediaRecorder.addEventListener('dataavailable', (event) => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('stop', async () => {
                    const mimeType = mediaRecorder.mimeType;
                    let blob = new Blob(audioChunks, { type: mimeType });
                    
                    // Convert webm to WAV using Web Audio API
                    if (mimeType.includes('webm')) {
                        try {
                            blob = await convertWebmToWav(blob);
                        } catch (e) {
                            console.log('Conversion failed, using original format:', e);
                        }
                    }
                    
                    currentAudioBlob = blob;
                    const audioUrl = URL.createObjectURL(currentAudioBlob);
                    recordedAudio.src = audioUrl;
                    recordedAudio.style.display = 'block';
                    
                    // Set playback rate based on selected speed
                    const selectedSpeed = parseFloat(document.querySelector('input[name="speed"]:checked').value);
                    recordedAudio.playbackRate = selectedSpeed;
                    
                    processBtn.disabled = false;
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                });
                
                mediaRecorder.start();
                recordBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } catch (err) {
                showStatus('error', 'æ— æ³•è®¿é—®éº¦å…‹é£: ' + err.message);
            }
        });
        
        // Convert webm to WAV using Web Audio API
        async function convertWebmToWav(webmBlob) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const arrayBuffer = await webmBlob.arrayBuffer();
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            // Convert AudioBuffer to WAV
            const wavBuffer = audioBufferToWav(audioBuffer);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }
        
        // Convert AudioBuffer to WAV format
        function audioBufferToWav(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2 + 44;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new DataView(arrayBuffer);
            const channels = [];
            let offset = 0;
            let pos = 0;
            
            // Write WAV header
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"
            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(buffer.numberOfChannels);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 2 * buffer.numberOfChannels); // avg. bytes/sec
            setUint16(buffer.numberOfChannels * 2); // block-align
            setUint16(16); // 16-bit
            setUint32(0x61746164); // "data" - chunk
            setUint32(length - pos - 4); // chunk length
            
            // Write interleaved data
            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }
            
            while (pos < length - 44) {
                for (let i = 0; i < buffer.numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }
            
            return arrayBuffer;
            
            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }
            
            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
        
        stopBtn.addEventListener('click', () => {
            mediaRecorder.stop();
            recordBtn.style.display = 'block';
            stopBtn.style.display = 'none';
        });
        
        // Process audio
        processBtn.addEventListener('click', async () => {
            if (!currentAudioBlob) {
                showStatus('error', 'è¯·å…ˆå½•éŸ³');
                return;
            }
            
            showStatus('processing', 'æ­£åœ¨å¤„ç†éŸ³é¢‘...è¯·ç¨å€™');
            processBtn.disabled = true;
            outputAudio.style.display = 'none';
            
            const formData = new FormData();
            formData.append('audio', currentAudioBlob, 'recording.wav');
            formData.append('semitones', semitonesSlider.value);
            // Speed will be controlled during playback, not during processing
            
            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Processing failed');
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                outputAudio.src = url;
                outputAudio.style.display = 'block';
                
                // Set playback rate based on selected speed
                const selectedSpeed = parseFloat(document.querySelector('input[name="speed"]:checked').value);
                outputAudio.playbackRate = selectedSpeed;
                
                // Show speed control section
                document.getElementById('speedControlSection').style.display = 'block';
                
                showStatus('success', 'âœ“ é™è°ƒæˆåŠŸï¼è¯·åœ¨ä¸‹æ–¹æ”¶å¬:');
            } catch (err) {
                showStatus('error', 'é”™è¯¯: ' + err.message);
            } finally {
                processBtn.disabled = false;
            }
        });
        
        function showStatus(type, message) {
            status.className = 'status ' + type;
            status.textContent = message;
        }
    </script>
</body>
</html>
